function showDialog(n){var t=$("#"+n);t.dialog({width:getWidth()>400?getWidth()*8/10:310,height:getHeight()>300?getHeight()*7.5/10:200,open:function(){if(track){var n=new google.maps.ElevationService;n.getElevationAlongPath({path:compactTrackData(track.trackData),samples:128},plotElevation)}$("#tabs-movie").tabs({create:function(){$(".fb-comments").attr("data-width",getWidth()>400?getWidth()*7/10:280)}})}})}function pointToLatLng(n){var t,i,r;return n.hasOwnProperty("lat")?(t=new L.LatLng(n.lat,n.lng),n.hasOwnProperty("syt_text")&&(t.syt_text=n.syt_text),n.hasOwnProperty("syt_audio")&&(t.syt_audio=n.syt_audio),t):(i=n[0],r=n[1],t=new L.LatLng(i,r),n.length>2&&(t.syt_text=n[2],n.length>3&&(t.syt_audio=n[3])),t)}function translateTracksPath(n){return tracksFolder+n}function translateTracksContentPath(n){return tracksFolder+"content/"+n}function clickHelp(){$("#menuPanel").hide("slide",500);$("#helpPanel").show("slide",{direction:"right"},500)}function clickSettings(){$("#menuPanel").hide("slide",500);$("#settingsPanel").show("slide",{direction:"up"},500)}function clickMenu(){$("#helpPanel").hide("slide",{direction:"right"},500);$("#settingsPanel").hide("slide",{direction:"up"},500);$("#menuPanel").toggle("slide",500)}function onBodyResize(){$("#map").length&&$("#map").height(window.innerHeight);$("#menuPanel").length&&$("#menuPanel").height(window.innerHeight-100);$(".viewport").length&&$(".viewport").height(window.innerHeight-150);typeof switchSidePanel!="undefined"&&(window.innerWidth<800&&showSidePanel!="no"?switchSidePanel(!1):switchSidePanel(!0))}function showLocation(){if(navigator.geolocation)navigator.geolocation.getCurrentPosition(showPosition,errorPosition,{enableHighAccuracy:!0,timeout:3e4,maximumAge:3e5}),setTimeout(arguments.callee,3e5)}function errorPosition(n){console.warn("Cannot get position("+n.code+"): "+n.message)}function showPosition(n){var i,t;$("#map").length&&(i=new L.LatLng(n.coords.latitude,n.coords.longitude),markerWhereIAm.setLatLng(i),typeof track=="undefined"&&map.setView(i,8),t="services/user_locations.aspx?action=senduserlocation&userId="+globalUserId+"&lat="+n.coords.latitude.toString()+"&lng="+n.coords.longitude.toString(),$.ajax({dataType:"jsonp",url:t,success:function(){},error:function(n,t,i){console.log("senduserlocation error status: "+t);console.log("Error: "+i)}}),t="services/user_locations.aspx?action=getfriendslocations&userId="+globalUserId,markersFriends.clearLayers(),$.ajax({dataType:"jsonp",url:t,success:function(n){var t,i;for(t in n)i=L.marker(new L.LatLng(n[t].lat-.0002+Math.random()*.0004,n[t].lng-.0002+Math.random()*.0004),{icon:iconFriend}).bindPopup(n[t].userName.concat(", ",n[t].time)),markersFriends.addLayer(i)},error:function(n,t,i){console.log("getfriendslocations error status: "+t);console.log("Error: "+i)}}))}function SaveSettings(){$.cookie("settings_scriptTextCheckBox",$("#scriptTextCheckBox").is(":checked"));$.cookie("settings_imagesCheckBox",$("#imagesCheckBox").is(":checked"));$.cookie("settings_loopTrackCheckBox",$("#loopTrackCheckBox").is(":checked"));$.cookie("settings_useFlickrImagesCheckBox",$("#useFlickrImagesCheckBox").is(":checked"));$.cookie("settings_useSYTImagesCheckBox",$("#useSYTImagesCheckBox").is(":checked"));$.cookie("settings_useGooglePlacesCheckBox",$("#useGooglePlacesCheckBox").is(":checked"));$.cookie("settings_useSYTPlacesCheckBox",$("#useSYTPlacesCheckBox").is(":checked"));$.cookie("settings_mapStyle",$("#mapStyle option:selected").val());$.cookie("settings_volume",$("#slider").slider("value"));$.cookie("settings_mute",audio.muted)}function LoadSettings(){if(typeof $.cookie("settings_scriptTextCheckBox")!="undefined"){var n=$.cookie("settings_scriptTextCheckBox")=="true",t=$.cookie("settings_imagesCheckBox")=="true",i=$.cookie("settings_mute")=="true",r=$.cookie("settings_loopTrackCheckBox")=="true";$("#scriptTextCheckBox").prop("checked",n);$("#imagesCheckBox").prop("checked",t);$("#loopTrackCheckBox").prop("checked",r);$("#useFlickrImagesCheckBox").prop("checked",$.cookie("settings_useFlickrImagesCheckBox")=="true");$("#useSYTImagesCheckBox").prop("checked",$.cookie("settings_useSYTImagesCheckBox")=="true");$("#useGooglePlacesCheckBox").prop("checked",$.cookie("settings_useGooglePlacesCheckBox")=="true");$("#useSYTPlacesCheckBox").prop("checked",$.cookie("settings_useSYTPlacesCheckBox")=="true");n&&$("#textToReadArea0").toggle("fold",1e3);t||$("#imageDiv0").toggle("fold",1e3);i&&clickMute()}typeof $.cookie("settings_mapStyle")!="undefined"&&($("#mapStyle").val($.cookie("settings_mapStyle")),selectMapStyle());typeof $.cookie("settings_volume")!="undefined"&&$("#slider").slider("value",$.cookie("settings_volume"))}function clickMute(){audio.muted?(audio.muted=!1,$("#mute").css("background-image","url(img/unmute.png )")):(audio.muted=!0,$("#mute").css("background-image","url(img/mute.png )"))}function doStartStop(){isTrackLoaded?($("#continuePauseButton").removeAttr("disabled"),isTrackPaused?(isTrackPaused=!isTrackPaused,typeof animatedMarker!="undefined"&&animatedMarker.startagain(),track.audioSrc&&track.audioSrc.length>0&&audio.play(),scrollerEnabled=!0,$("#continuePauseButton").css("background-image","url(img/pause.png )"),$("#showGoesOn").length>0&&$("#showGoesOn").val("1")):(isTrackPaused=!isTrackPaused,typeof animatedMarker!="undefined"&&animatedMarker.stop(),audio.pause(),scrollerEnabled=!1,$("#continuePauseButton").css("background-image","url(img/play.png )"),$("#showGoesOn").length>0&&$("#showGoesOn").val("0"))):$("#continuePauseButton").attr("disabled","disabled")}function showPhotos(n,t,i){i||(i=n.photoLocationTolerancy/1e3);i||(i=.1);Promise.all([syt.api.searchSYTImages(n,t,i),syt.api.searchFlickrImages(n,t,i)]).then(n=>{get_photos_success(n[0].photos.concat(n[1].photos),t,i)})}function get_photos_success(n,t){var e=$("#imageDiv").height(),h=$("#imageDiv").width(),u,i,s;for(shuffle(n),count=n.length,$("#lblCoord").text(t.lat+" "+t.lng),u=imageDiv.children(),u.fadeOut(100),u.empty(),i=0;i<n.length;i++){var o=document.createElement("li"),f=document.createElement("a"),r=document.createElement("img");f.href=n[i].photo_url;f.target="_blank";r.width=n[i].width*e/n[i].height;r.height=e;cacheImages==!0?getFromCacheOrServer(n[i].photo_file_url,r,function(n,t){n.src=t}):r.src=n[i].photo_file_url;s=$.t("Photo from {0} by {1}. Click to open the source.");r.title=s.format([n[i].photo_title,n[i].owner_name]);r.classList.add("photo");f.appendChild(r);o.appendChild(f);u[0].appendChild(o)}curX=0;scrollerContent.children().clone().appendTo(scrollerContent);scrollerContent.children().each(function(){var n=$(this),t;n.css("left",curX);t=n.children().children()[0];curX+=t.width});fullW=curX/2;viewportW=scroller.width();u.fadeIn(100)}function GPXtoLatLng(n){var i="",r,t;for(xmlhttp=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),xmlhttp.open("GET",n+"?"+Math.random(),!1),xmlhttp.send(),xmlDoc=xmlhttp.responseXML,r=xmlDoc.getElementsByTagName("trkpt"),t=0;t<r.length;t++)i.length>0&&(i+=","),i+="["+r[t].getAttribute("lat").toString()+","+r[t].getAttribute("lon").toString()+"]";return"["+i+"]"}function selectMapStyle(){var n=$("#mapStyle option:selected").val();map.removeLayer(tileLayer);tileLayer=L.tileLayer(mapTileUrl,{attribution:'SeeYourTravel.com &copy; Map data &copy; <a href="https://www.mapbox.com/">MapBox<\/a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA<\/a>, Imagery © <a href="http://cloudmade.com">CloudMade<\/a> <img src="img/poweredbygoolge/desktop/powered-by-google-on-white.png"/>',maxZoom:18,id:n});tileLayer.addTo(map)}function fixTrackData(n){for(var u,f,i=[],r=0,t=0;t<n.trackData.length;t++)u=n.trackData[t],f=pointToLatLng(u),i.push(f),t>0&&(r=r+i[t].distanceTo(i[t-1]));n.trackData=i;n.avgDistM=r/(t-1)}function loadTrack(n,t){var i=n+"?"+Math.random();$.ajax({url:i,dataType:"json",error:function(n,t,i){console.log("loadTrack error: "+t);console.log("Error: "+i)},success:function(n){var i=n;i.trackGpx&&(i.trackData=$.parseJSON(GPXtoLatLng(translateTracksContentPath(i.trackGpx))));fixTrackData(i);$("#textToReadArea").length>0&&(textToReadArea.innerHTML=isNullOrEmpty(i.textToRead)?"":$.ajax({url:translateTracksContentPath(i.textToRead+"?"+Math.random()),async:!1}).responseText);t(i)}})}function init(n,t){if(typeof map!="undefined"?(markers.clearLayers(),map.removeLayer(markers)):(map=L.map("map",{zoomControl:!1}),tileLayer=L.tileLayer(mapTileUrl,{attribution:'SeeYourTravel.com &copy; Map data &copy; <a target-"_blank" href="http://openstreetmap.org">OpenStreetMap<\/a> contributors, <a target-"_blank" href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA<\/a>, Imagery © <a target-"_blank" href="http://flickr.com">Flickr<\/a> <img src="img/poweredbygoolge/desktop/powered-by-google-on-white.png"/>',maxZoom:20,id:"mapbox.streets"}),tileLayer.addTo(map),L.control.scale({position:"bottomleft"}).addTo(map),L.control.zoom({position:"topright"}).addTo(map)),markers=new L.FeatureGroup,map.addLayer(markers),typeof markersFriends=="undefined"&&(markersFriends=new L.FeatureGroup,markers.addLayer(markersFriends)),typeof markersTracks=="undefined"&&(markersTracks=new L.FeatureGroup,markers.addLayer(markersTracks)),markerWhereIAm=L.marker(new L.LatLng(1e3,1e3),{icon:iconWhereIAm,zIndexOffset:100}).bindPopup(globalUserName),markers.addLayer(markerWhereIAm),showLocation(),n){var i=translateTracksPath(n+".js");loadTrack(i,function(n){var r,i,s;track=n;var f=L.icon({iconUrl:translateTracksContentPath(track.icon),iconSize:[markerSize,markerSize],iconAnchor:[1,markerSize],shadowUrl:null}),e=new Date(2e3,2),h={distance:track.velocityMetersPerSec,interval:1e3,icon:f,autoStart:!1,onEnd:function(){$("#loopTrackCheckBox").is(":checked")&&animatedMarker.start()},onStep:function(n){counter++;n.hasOwnProperty("syt_text")&&n.syt_text!=""&&toastr.info(n.syt_text,"",{timeOut:5e3,extendedTimeOut:1e4});n.hasOwnProperty("syt_audio")&&(audio.src=translateTracksContentPath(n.syt_audio),audio.play());var t=new Date;(t.getTime()-e.getTime())/1e3>updateIntervalSeconds&&(map.setView([n.lat,n.lng],map.getZoom()),showPhotos(track,n),e=t)}};for(r=0;r<track.trackData.length;r++)if(i=track.trackData[r],i.hasOwnProperty("syt_text")&&i.syt_text!=""){var c=L.icon({iconUrl:"img/info.png",iconSize:[25,25],iconAnchor:[13,25]}),o=i.syt_text.toString(),u=document.createElement("a");u.innerHTML="<p>"+o+"<\/p>";u.alt=o;s=L.marker(new L.LatLng(i.lat,i.lng),{icon:c}).bindPopup(u);markers.addLayer(s)}animatedMarker=L.animatedMarker(track.trackData,h);animatedMarker.setIcon(f);markers.addLayer(animatedMarker);line=L.polyline(track.trackData,{color:"green"});markers.addLayer(line);markerStart=L.marker(track.trackData[0]).bindPopup("Start");markers.addLayer(markerStart);markerFinish=L.marker(track.trackData[track.trackData.length-1]).bindPopup("Finish");markers.addLayer(markerFinish);map.setView(track.trackData[0],track.defaultScale?track.defaultScale:8);track.audioSrc&&track.audioSrc.length>0&&(audio.src=translateTracksContentPath(track.audioSrc),track.audioVolume&&(audio.volume=track.audioVolume?track.audioVolume:.8,$("#slider").slider("value",audio.volume)));addMarkersNearAll(track.trackData,GOOGLE_TYPES);isTrackLoaded=!0;t&&t()})}}function addMarkersNearAll(n,t){for(var f,r,i=0;i<myMarkers.length;i++)f=myMarkers[i],map.removeLayer(f);for(myMarkers=[],allMarkers=[],r=3,i=0;i<r;i++){var e=Math.round(n.length*i/3),o=Math.round(n.length*(i+1)/3),u=Math.round(n.length/(10*r));u==0&&(u=1);doSetTimeout(n,t,e,o,u,i)}}function doSetTimeout(n,t,i,r,u,f){setTimeout(function(){addMarkersNearRange(n,t,i,r,u,f%2==1)},f*5e3+1)}function addMarkersNearRange(n,t,r,u,f,e){for(i=r;i<u;i+=f){var o=n[i];addMarkersNear(o.lat,o.lng,t,e)}}function addMarkersNear(n,t,i){var u=new google.maps.LatLng(n,t),r={location:u,radius:MAX_GOOGLE_RADIUS,types:i},f=new google.maps.places.PlacesService(map2);Promise.all([syt.api.searchSYTPlaces(r),syt.api.searchWikiPlaces(r),syt.api.searchGooglePlaces(f,r)]).then(n=>{getplaces_success(n[0].concat(n[1]).concat(n[2]))})}function getplaces_success(n){for(var t=0;t<Math.min(n.length,100);t++)createPhotoMarker(n[t])}function createPhotoMarker(n){var t,f;if(allMarkers.indexOf(n.id)<0)allMarkers.push(n.id);else return;if(t=n.photos,t){var r=t[0].getUrl?!0:!1,u=n.types.indexOf("wiki")>=0,e=L.icon({iconUrl:n.types.indexOf("lodging")>=0?"img/lodging.png":n.types.indexOf("restaurant")>=0?"img/restaurant1.png":n.types.indexOf("museum")>=0?"img/museum.png":n.types.indexOf("park")>=0?"img/park.png":n.types.indexOf("bakery")>=0?"img/bakery.png":n.types.indexOf("zoo")>=0?"img/zoo.png":u?"img/wiki.png":"img/something.png",iconSize:u?[26,26]:[26,35]}),i=document.createElement("a");i.innerHTML="<p>"+n.name+"<\/p><img height='100px' width='100px' src='"+(r?t[0].getUrl({maxWidth:100,maxHeight:100}):t[0].raw_reference.fife_url)+"'/>";i.alt=n.name;i.onclick=function(){window.open(u?"https://"+getTwitterLanguage()+".wikipedia.org/?curid="+n.id:"https://www.google.com.ua/search?q="+n.name,"_blank")};f=L.marker(new L.LatLng(r?n.geometry.location.lat():n.geometry.location.lat,r?n.geometry.location.lng():n.geometry.location.lng),{icon:e}).bindPopup(i);myMarkers.push(f);markers.addLayer(f)}}function getFromCacheOrServer(n,t,i){var u=$.jStorage.get(n),r;u?i(t,u):(r=new XMLHttpRequest,r.open("GET",n,!0),r.responseType="blob",r.onload=function(){if(this.status==200){var u=new Blob([this.response],{type:"image/png"}),r=new window.FileReader;r.readAsDataURL(u);r.onloadend=function(r){var u=r.target.result;$.jStorage.set(n,u,{TTL:864e5});i(t,u)}}},r.send())}function plotElevation(n,t){var u=document.getElementById("elevationChartDiv"),f,r,i,e;if(t!=="OK"){u.innerHTML="Cannot show elevation: request failed because "+t;return}for(u.innerHTML='<canvas id="elevationChartCanvas" height="250"><\/canvas>',f=document.getElementById("elevationChartCanvas"),r={labels:[],datasets:[{label:"Elevation",data:[]}]},i=0;i<n.length;i++)e=(Math.round(n[i].location.lat()*1e4)/1e4).toString()+", "+(Math.round(n[i].location.lng()*1e4)/1e4).toString(),r.labels.push(e),r.datasets[0].data.push(Math.round(n[i].elevation));myBarChart=new Chart(f,{type:"bar",data:r,options:{hover:{mode:"nearest"}}})}function compactTrackData(n){var r=[],i=256,t,u;if(n.length<=i)return n;for(t=0;t<i;t++)u=Math.round(t*n.length/i),r.push(n[u]);return r}var tracksFolder="tracks/",mapTileUrl="https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoib2x0dXJ1YSIsImEiOiJlODQ4ZTI2MWI4OGZkZjUyNDRiNjY4MDFkZGI0ODc4NyJ9.iiCb_tZgs_ipvEv3s6Zx0A",flickrUrl="https://api.flickr.com/services/rest/?method=flickr.photos.search&bbox={0}%2C{1}%2C{2}%2C{3}&per_page={4}&format=json&nojsoncallback=1&api_key=2203a1e292f7b65958730b236c0756fa",MAX_GOOGLE_PLACES=10,MAX_HERE_PLACES=50,MAX_GOOGLE_RADIUS=1e4,GOOGLE_TYPES=["lodging","restaurant","museum","park","bakery","zoo"],sidePanelWidth=200,cacheImages=!1,updateIntervalSeconds=5,scrollerEnabled=!1,scroller,scrollerContent,curX,fullW,viewportW,myBarChart=null,versionUrl="services/get_version.aspx",iconWhereIAm=L.icon({iconUrl:"img/youarehere.png",iconSize:[30,50],iconAnchor:[15,50]}),iconFriend=L.icon({iconUrl:"img/friendlocation.png",iconSize:[30,30],iconAnchor:[15,30]}),isTrackLoaded=!1,iOS=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,isTrackPaused=!iOS,myMarkers=[];$(function(){onBodyResize();$.ajax({url:versionUrl,success:function(n){var t=$("<input/>",{type:"hidden",id:"version",value:n});t.appendTo("form")},error:function(n,t,i){console.log("get version error: "+t);console.log("Error: "+i)}});scroller=$("#imageDiv0 div.innerScrollArea");scrollerContent=scroller.children("ul");curX=0;fullW=1;var n={curSpeed:0,fullSpeed:2},t=$(n),i=function(n,i){i===undefined&&(i=600);t.stop(!0).animate({curSpeed:n},i)},r=function(){if(scrollerEnabled){var i=scroller.scrollLeft(),t=i+n.curSpeed;t>fullW*2-scroller.width()&&(t-=fullW);scroller.scrollLeft(t)}};setInterval(r,20);i(n.fullSpeed)});